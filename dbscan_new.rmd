---
title: "DB Scan Cludstering"
author: "Michael Santoro"
output: pdf_document
---

# Introduction
In this exploration of DBScan (Density Based Scan) clustering we will be exploring the if the images of clothes can be clustered togther by the item
type of clothing. We are using the clothing dataset from kaggle found here: https://www.kaggle.com/agrigorev/clothing-dataset-full?select=images.csv

```{r}

library(dplyr)
library(dbscan)
library(OpenImageR)
library(SuperpixelImageSegmentation)
library(glue)
library(ggplot2)

```

The files from Kaggle include the labels of the data included in a file names images.csv. Below we read in this data-set.

```{r}
images <- read.csv("images.csv", header=TRUE, sep=",") 
```

The block below checks the types of the variables included in the dataset.

```{r}
str(images)
```

```{r}
ggplot(images, aes(x = label, color=label)) +        # Create   barchart with ggplot2
  geom_bar() +
  ggtitle("Bar Plot of Labels")
```

```{r}
table(images$label)
```

```{r}
dropRows<-images %>% count(label)

dropRows<- dropRows[which(dropRows$n<200),]

```

We will drop the categories with labels less than 200.

```{r}
images <- subset(images, !(label %in% dropRows$label))
# images <- images[which(images$label != "Not Sure"),] #Function is not working
```

```{r}
table(images$label)
```

## Image Exploration

The following function will take in a string and return an array of the image, with the following.
We are using superpixel segementation to allow for the variance of of the distance to be less across images. As quoted from the article in the link below: "In this respect, superpixels address two problems inherent to the processing of digital images: firstly, pixels are merely a result of discretization; and secondly, the high number of pixels in large images prevents many algorithms from being computationally feasible."
This is a form of trying soften the edges: https://cran.r-project.org/web/packages/OpenImageR/vignettes/Image_segmentation_superpixels_clustering.html.
For the other image functions: https://cran.r-project.org/web/packages/OpenImageR/vignettes/The_OpenImageR_package.html

```{r}
imageTrasform <- function(name) {
  #The name is passed in as string and needs to be concatenated into the file path
  file <- glue("images_compressed/{name}.jpg")
  print(file)
  
  #Read in the file
  img <- readImage(file)
  
  #Crop image
  img <- cropImage(img, new_width = 400, new_height = 400, type = 'equal_spaced')
  
  
  
  #Super Pixel Transform
  init = Image_Segmentation$new()
  spx = suppressWarnings(init$spixel_segmentation(input_image = img, 
                               superpixel = 600, 
                               AP_data = TRUE,
                               use_median = TRUE, 
                               sim_wL = 3, 
                               sim_wA = 10, 
                               sim_wB = 10,
                               sim_color_radius = 10, 
                               #verbose = TRUE
                               verbose = FALSE
                               ))
  
  #Convert image to grayscale
  gry <- rgb_2gray(spx$AP_image_data)
  
  #Resize Image (50,50 looks better but running out of memory when running DBScan)
  gry = resizeImage(gry, width = 10, height = 10, method = 'bilinear', normalize_pixels = TRUE)

  
  #Show the image
  imageShow(gry)
  return(gry)
}
```

```{r}
gry1 <- imageTrasform("00bede7c-eae4-4ee9-a1ac-1721b3f94c54")
gry2 <- imageTrasform("00d9cc6e-2564-4813-9d68-4bc4d562107b")
```

We can get a distance from one image to another.

```{r}
res <- median(abs(gry1-gry2))

```


##Data Preparation for Input
We will need to create a matrix.

```{r}
#Currently only first 25 images
transformed_images <- sapply(images$image[1:25],imageTrasform)
```


```{r}
table(images$label[1:25])
```


##DBScan Clustering
Since we know from the data that none of our categories have less than 200 in a group we will pass this in as the minPts value.
The eps value we will set to larger than what we had for the average distance between the two sample images.


```{r}
res <- dbscan(t(transformed_images), eps = 1.7, MinPts = 1)
res
```

